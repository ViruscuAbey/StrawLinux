name: Build StrawLinux ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Build ISO using Docker (Arch Linux)
        run: |
          docker run --privileged --rm -v $(pwd):/workspace -w /workspace archlinux:latest bash -c "
            set -e  # Hata olursa dur

            # 1. Update and setup prerequisites
            pacman-key --init
            pacman-key --populate archlinux
            pacman -Syu --noconfirm --needed git base-devel

            # 2. Setup Chaotic AUR
            pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
            pacman-key --lsign-key 3056513887B78AEB
            pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
            pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'
            
            # Add repo to config
            echo '' >> /etc/pacman.conf
            echo '[chaotic-aur]' >> /etc/pacman.conf
            echo 'Include = /etc/pacman.d/chaotic-mirrorlist' >> /etc/pacman.conf
            
            # Update cache with new repo
            pacman -Sy

            # 3. Install archiso tools and bootloaders
            pacman -S --noconfirm archiso syslinux grub

            # 4. Prepare Build Directory
            # Copy default releng profile as base
            cp -r /usr/share/archiso/configs/releng /tmp/strawlinux-build
            
            # Clean default packages files from releng to avoid conflicts
            # (We want to use OUR packages list, but keep bootloaders etc)
            # rm /tmp/strawlinux-build/packages.x86_64
            
            # Overlay our repo files on top of releng
            # Force copy everything from our repo to the build folder
            cp -r /workspace/repo/* /tmp/strawlinux-build/
            
            # 5. Build the ISO
            cd /tmp/strawlinux-build
            
            # Ensure permissions
            chmod +x profiledef.sh
            
            # Start Build
            echo 'Building StrawLinux ISO...'
            mkarchiso -v -w /tmp/archiso-work -o /workspace/out ./
          "

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StrawLinux-ISO
          path: out/*.iso
          retention-days: 5
